#!/usr/bin/lua

local uci = require('simple-uci').cursor()
local site = require 'gluon.site'

local private_key = uci:get("network", "vpn", "private_key")

if not private_key or not private_key:match("^" .. ("[%a%d+/]"):rep(43) .. "=$") then
  private_key = "generate"
end

uci:section('network', 'interface', 'vpn', {
  proto = 'wireguard',
  fwmark = 1,
  disabled = true, -- this is actually handled by 500-mesh-vpn in gluon-mesh-vpn-core
  private_key = private_key,
})

-- Clean up previous configuration
uci:delete_all('wgpeerselector', 'peer', function(peer)
  return peer.preserve ~= '1'
end)

for name, peer in pairs(site.mesh_vpn.wireguard.peers()) do
  uci:section("wgpeerselector", "peer", name, {
    enabled = true,
    endpoint = peer.endpoint,
    public_key = peer.public_key,
    allowed_ips = { "fe80::1/128" },
    ifname = 'vpn',
  })
end

uci:save("wgpeerselector")
uci:save("network")
